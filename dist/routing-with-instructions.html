<!DOCTYPE html>
<html class='use-all-space'>
    <head>
        <meta http-equiv='X-UA-Compatible' content='IE=Edge' />
        <meta charset='UTF-8'>
        <title>Maps SDK for Web - Routing with instructions</title>
        <meta name='viewport'
            content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'/>
        <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.23.0/maps/maps.css'>
        <link rel='stylesheet' type='text/css' href='../assets/ui-library/index.css'/>
        <link rel='stylesheet' type='text/css' href='../assets/ui-library/dashBoard.css'/>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/plugins/SearchBox/3.2.0//SearchBox.css'/>
        <link rel='stylesheet' type='text/css' href='../assets/ui-library/icons-css/routing.css'/>
    </head>
    <style>
        .map-view .icon {
            height: 30px;
            width: 30px;
        }
        .map-view .tt-icon.-finish {
            height: 16px;
            width: 16px;
        }
        .map-view .icon-spacing {
            float: left;
            margin-right: 14px;
            margin-top: 24px;
        }
        .map-view .input-wrapper {
            display: flex;
            min-height: 120px;
        }
        .map-view .searchbox {
            float: left;
            width: 100%;
        }
        .map-view .supporting-marker {
            align-items: center;
            background-color: #4a90e2;
            border: solid 3px #2faaff;
            border-radius: 50%;
            display: flex;
            height: 32px;
            justify-content: center;
            transition: width .1s, height .1s;
            width: 32px;
        }
        .map-view .tt-results-list__item {
            padding: 0;
        }
        .map-view .guidance-marker.not-visible {
            /* display: none; */
        }
    </style>
    <body>
<div>
    <form id="hide" class='tt-side-panel js-form'>
        <header class='tt-side-panel__header'>
            <div class='input-wrapper'>
                <div class='tt-icon icon-spacing -start'></div>
                <div id='startSearchBox' class='tt-form-label searchbox'></div>
            </div>
            <div class='input-wrapper'>
                <div class='tt-icon icon-spacing -finish'></div>
                <div id='finishSearchBox' class='tt-form-label searchbox'></div>
            </div>  
        </header>
        <div id="toggleBtn"><i class="fa-solid fa-circle-xmark fa-lg" id="close-icon"></i></div>
    </form>

   <div id='map' class='map-view'>

            <!-- <div hidden="hidden"></div>
                <div id="instruction-tab-top" class='tt-tabs-top' >
                    <div id=" " class='tt-tabs__panel js-tabs' hidden="hidden">
                        <div class='tt-results-list js-results' ></div>
                        <div class='js-results-loader' hidden='hidden'>
                            <div class='loader-center'><span class='loader'></span></div>
                        </div>
                        <div class='tt-tabs__placeholder js-results-placeholder -small'> 
                        </div>
                    </div>
                </div> -->
                <div id="" class="click-popup-div">
                    <div class="clear"><i class="fa-solid fa-arrow-rotate-left"></i></div>
                    <div class="onclicked"></div>
                </div>
                
                
                <div hidden="hidden"></div>
                <div id="instruction-tab" class='tt-tabs' >
                    <div id=" " class='tt-tabs__panel js-tabs' hidden="hidden">
                        <div class='tt-results-list js-results' ></div>
                        <div class='js-results-loader' hidden='hidden'>
                            <div class='loader-center'><span class='loader'></span></div>
                        </div>
                        <div class='tt-tabs__placeholder js-results-placeholder -small'>
                        </div>
                    </div>
                </div>
            

            <!--THE SEARCH UI-->
            <div id="search" class='tt-side-panel-search'>
                <header class='tt-side-panel__header-search'>
                </header>
                <div class='tt-tabs js-tabs-search' >
                    <div class='tt-tabs__panel' hidden="hidden">
                        <div class='js-results-search' hidden='hidden'></div>
                        <div class='js-results-loader-search' hidden='hidden'>
                            <div class='loader-center'><span class='loader'></span></div>
                        </div>
                        <div class='tt-tabs__placeholder js-results-placeholder-search'>hey there</div>
                    </div>
                </div>
                <div  class="route-button" onclick="toggle()">
                    <i id="route-direction" class="fa-solid fa-route"></i></div>
            </div>   
            <div  class='full-map'></div>
  </div>
</div>
        <script src='https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.23.0/maps/maps-web.min.js'></script>
        <script src='https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.23.0/services/services-web.min.js'></script>
        <script src='https://api.tomtom.com/maps-sdk-for-web/cdn/plugins/SearchBox/3.2.0//SearchBox-web.js'></script>

        <script data-showable type='text/javascript' src='../assets/js/search-markers/search-marker.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/search/search-results-parser.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/search-markers/search-markers-manager.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/search/side-panel.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/mobile-or-tablet.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/search/dom-helpers.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/foldable.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/formatters.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/info-hint.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/search/results-manager.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/search/results-manager-search.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/guidance-panel.js'></script>
        <script data-showable type='text/javascript' src='../assets/js/search/searchbox-enter-submit.js'></script>

        <script>
       
        function toggle(){
            let blurElement = document.querySelector('#map');
            blurElement.classList.toggle('activeBlur');
            // blurElement.classList.toggle(activeBlur)
            let routePop = document.querySelector('#hide');
            routePop.classList.toggle('active');
           
        }

        
            let toggleBtn = document.querySelector('#toggleBtn');
            toggleBtn.addEventListener('click', function(){
                let blurElement = document.querySelector('#map');
                blurElement.classList.toggle('activeBlur');
                // blurElement.classList.toggle(activeBlur)
                let routePop = document.querySelector('#hide');
                routePop.classList.toggle('active');
            })
   
            let returnDiv = document.querySelector('.clear');
            returnDiv.addEventListener('click', function(){
                //toggle guidance-panel and the search-panel
                const generalGuidancePanel = document.querySelector('#instruction-tab');
                const sidePanelSearch = document.querySelector('#search');
                generalGuidancePanel.classList.toggle('active')
                sidePanelSearch.classList.toggle('active')

                //toggle our topvisible div
                const onclickedDivVisible = document.querySelector('.click-popup-div')
                onclickedDivVisible.classList.toggle('active-click')
            })


            //creating general map
            var map = tt.map({
                key: 'GZ2CohvCdB2RplDFGwFCyCg8gWO0YSKQ',
                container: 'map',
                dragPan: !isMobileOrTablet()
            });

            var finishMarkerElement = createMarkerElement('finish');
            var startMarkerElement = createMarkerElement('start');

            var errorHint = new InfoHint('error', 'bottom-center', 5000).addTo(document.getElementById('map'));
            var loadingHint = new InfoHint('info', 'bottom-center').addTo(document.getElementById('map'));
            var resultsManager = new ResultsManager();

            var routeMarkers = {}, routePoints = {}, searchBox = {};

            map.addControl(new tt.FullscreenControl({container: document.querySelector('body')}));
            map.addControl(new tt.NavigationControl());
            map.on('load', function() {
                searchBox.start = createSearchBox('start');
                searchBox.finish = createSearchBox('finish');
            });

            function addRouteMarkers(type, point) {
                var lngLat = point && point[type + 'Point'] || routePoints[type];

                if (!routeMarkers[type] && routePoints[type]) {
                    routeMarkers[type] = createMarker(type, lngLat);
                }
                if (routeMarkers[type]) {
                    routeMarkers[type].setLngLat(routePoints[type]);
                }
            }

            function createMarkerElement(type, index) {
                var element = document.createElement('div');
                var innerElement = document.createElement('div');

                element.className = type === 'instruction' ?
                    'guidance-marker-' + (index || '') :
                    'supporting-marker';
                innerElement.className = 'tt-icon -white -' + type;
                element.appendChild(innerElement);
                return element;
            }

            function centerMap(lngLat) {
                map.flyTo({
                    center: lngLat,
                    speed: 10,
                    zoom: 8
                });
            }

            function clearMap() {
                if (!map.getLayer('route')) {
                    return;
                }
                map.removeLayer('route');
                map.removeSource('route');
            }

            function createMarker(type, lngLat) {
                var markerElement = type === 'start' ? startMarkerElement : finishMarkerElement;

                return new tt.Marker({ draggable: true, element: markerElement })
                    .setLngLat(lngLat)
                    .addTo(map)
                    .on('dragend', getDraggedMarkerPosition.bind(null, type));
            }

            function createSearchBox(type) {
                var searchBox = new tt.plugins.SearchBox(tt.services, {
                    showSearchButton: false,
                    searchOptions: {
                        key: 'GZ2CohvCdB2RplDFGwFCyCg8gWO0YSKQ'
                    },
                    labels: {
                        placeholder: 'Query e.g. Washington'
                    }
                });

                document.getElementById(type + 'SearchBox').appendChild(searchBox.getSearchBoxHTML());
                searchBox.on('tomtom.searchbox.resultscleared', onResultCleared.bind(null, type));

                searchBox.on('tomtom.searchbox.resultsfound', function(event) {
                    handleEnterSubmit(event, onResultSelected.bind(this), errorHint, type);
                });

                searchBox.on('tomtom.searchbox.resultselected', function(event) {
                    if (event.data && event.data.result) {
                        onResultSelected(event.data.result, type);
                    }
                });

                return searchBox;
            }

            function getDraggedMarkerPosition(type) {
                var lngLat = routeMarkers[type].getLngLat();

                performReverseGeocodeRequest(lngLat)
                    .then(function(response) {
                        var address = response.addresses[0];
                        var freeFormAddress = address.address.freeformAddress;

                        if (!freeFormAddress) {
                            loadingHint.hide();
                            clearMap();
                            resultsManager.resultsNotFound();
                            errorHint.setMessage('Address not found, please choose a different place');
                            return;
                        }
                        searchBox[type]
                            .getSearchBoxHTML()
                            .querySelector('input.tt-search-box-input')
                            .value = freeFormAddress;
                        var position = {
                            lng: address.position.lng,
                            lat: address.position.lat
                        };

                        updateMapView(type, position);
                    });
            }

            function handleCalculateRouteError() {
                clearMap();
                resultsManager.resultsNotFound();
                errorHint.setMessage('There was a problem calculating the route');
                loadingHint.hide();
            }

            function handleCalculateRouteResponse(response, type) {
                var geojson = response.toGeoJson();
                var feature = geojson.features[0];
                var coordinates = feature.geometry.coordinates;
                var guidance = feature.properties.guidance;

                clearMap();
                resultsManager.success();
                var guidancePanelElement = DomHelpers.elementFactory('div', 'guidance-panel');
                var guidancePanelElement1 = DomHelpers.elementFactory('div', 'guidance-panel1');
                resultsManager.append(guidancePanelElement);
                resultsManager.append(guidancePanelElement1);

                var guidancePanel = new GuidancePanel(guidance, {
                    map: map,
                    coordinates: coordinates
                });
                guidancePanel.bindEvents();

                map.addLayer({
                    'id': 'route',
                    'type': 'line',
                    'source': {
                        'type': 'geojson',
                        'data': geojson
                    },
                    'paint': {
                        'line-color': '#4a90e2',
                        'line-width': 6
                    }
                });
                var bounds = new tt.LngLatBounds();
                var point = {
                    startPoint: coordinates[0],
                    finishPoint: coordinates.slice(-1)[0]
                };

                addRouteMarkers(type, point);
                coordinates.forEach(function(point) {
                    bounds.extend(tt.LngLat.convert(point));
                });
                map.fitBounds(bounds, { duration: 0, padding: 50 });
                loadingHint.hide();
            }

            function handleDrawRoute(type) {
                errorHint.hide();
                loadingHint.setMessage('Loading...');
                resultsManager.loading();
                performCalculateRouteRequest()
                    .then(function(response) {
                        handleCalculateRouteResponse(response, type);
                    })
                    .catch(handleCalculateRouteError);
            }

            function onResultCleared(type) {
                routePoints[type] = null;
                if (routeMarkers[type]) {
                    routeMarkers[type].remove();
                    routeMarkers[type] = null;
                }
                if (shouldDisplayPlaceholder()) {
                    resultsManager.resultsNotFound();
                }
                if (routePoints.start || routePoints.finish) {
                    var lngLat = type === 'start' ? routePoints.finish : routePoints.start;

                    clearMap();
                    centerMap(lngLat);
                }
            }

            function onResultSelected(result, type) {
                var position = result.position;

                updateMapView(type, position);
            }

            function performCalculateRouteRequest() {
                return tt.services.calculateRoute({
                    key: 'GZ2CohvCdB2RplDFGwFCyCg8gWO0YSKQ',
                    instructionsType: 'tagged',
                    traffic: false,
                    locations: routePoints.start.join() + ':' + routePoints.finish.join()
                });
            }

            function performReverseGeocodeRequest(lngLat) {
                return tt.services.reverseGeocode({
                    key: 'GZ2CohvCdB2RplDFGwFCyCg8gWO0YSKQ',
                    position: lngLat
                });
            }

            function shouldDisplayPlaceholder() {
                return !(routePoints.start && routePoints.finish);
            }

            function updateMapView(type, position) {
                routePoints[type] = [position.lng, position.lat];
                if (routePoints.start && routePoints.finish) {
                    handleDrawRoute(type);
                } else {
                    addRouteMarkers(type);
                    centerMap(routePoints[type]);
                }
            }








/// Our Search Functionalities 



const routeBtn = document.getElementById('route-direction');

// let display = true;
// routeBtn.addEventListener('click', function(){
//     const div = document.getElementById('hide')
//     if (display) {
//       div.style.zIndex = '0';
//       display =false
//     } else {
//       div.style.zIndex = '1';
//       display = true
//     }
// });


        var infoHintSearch = new InfoHint('info', 'bottom-center', 5000).addTo(document.getElementById('map'));
        var errorHintSearch = new InfoHint('error', 'bottom-center', 5000).addTo(document.getElementById('map'));

// Options for the fuzzySearch service
        var searchOptions = {
            key: 'GZ2CohvCdB2RplDFGwFCyCg8gWO0YSKQ',
            language: 'en-GB',
            limit: 5
        };

        // Options for the autocomplete service
        var autocompleteOptions = {
            key: 'GZ2CohvCdB2RplDFGwFCyCg8gWO0YSKQ',
            language: 'en-GB'
        };

        var searchBoxOptions = {
            minNumberOfCharacters: 0,
            searchOptions: searchOptions,
            autocompleteOptions: autocompleteOptions,
            distanceFromPoint: [15.4, 53.0]
        };
        var ttSearchBox = new tt.plugins.SearchBox(tt.services, searchBoxOptions);
        document.querySelector('.tt-side-panel__header-search').appendChild(ttSearchBox.getSearchBoxHTML());

        var state = {
            previousOptions: {
                query: null,
                center: null
            },
            callbackId: null,
            userLocation: null
        };

        // map.addControl(new tt.FullscreenControl({container: document.querySelector('body')}));
        // map.addControl(new tt.NavigationControl());
        new SidePanel('.tt-side-panel-search', map);

        var geolocateControl = new tt.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: false
            }
        });

        geolocateControl.on('geolocate', function(event) {
            var coordinates = event.coords;
            state.userLocation = [coordinates.longitude, coordinates.latitude];
            ttSearchBox.updateOptions(Object.assign({}, ttSearchBox.getOptions(), {
                distanceFromPoint: state.userLocation
            }));
        });

        map.addControl(geolocateControl);

        var resultsManagerSearch = new ResultsManagerSearch();
        var searchMarkersManager = new SearchMarkersManager(map);

        map.on('load', handleMapEvent);
        map.on('moveend', handleMapEvent);

        ttSearchBox.on('tomtom.searchbox.resultscleared', handleResultsCleared);
        ttSearchBox.on('tomtom.searchbox.resultsfound', handleResultsFound);
        ttSearchBox.on('tomtom.searchbox.resultfocused', handleResultSelection);
        ttSearchBox.on('tomtom.searchbox.resultselected', handleResultSelection);

        function handleMapEvent() {
            // Update search options to provide geobiasing based on current map center
            var oldSearchOptions = ttSearchBox.getOptions().searchOptions;
            var oldautocompleteOptions = ttSearchBox.getOptions().autocompleteOptions;
            var newSearchOptions = Object.assign({}, oldSearchOptions, { center: map.getCenter() });
            var newAutocompleteOptions = Object.assign({}, oldautocompleteOptions, { center: map.getCenter() });
            ttSearchBox.updateOptions(Object.assign({}, searchBoxOptions, {
                placeholder: 'Query e.g. Washington',
                searchOptions: newSearchOptions,
                autocompleteOptions: newAutocompleteOptions,
                distanceFromPoint: state.userLocation
            }));
        }

        function handleResultsCleared() {
            searchMarkersManager.clear();
            resultsManagerSearch.clear();
        }

        function handleResultsFound(event) {
            // Display fuzzySearch results if request was triggered by pressing enter
            if (event.data.results && event.data.results.fuzzySearch && event.data.metadata.triggeredBy === 'submit') {
                var results = event.data.results.fuzzySearch.results;

                if (results.length === 0) {
                    handleNoResults();
                }
                searchMarkersManager.draw(results);
                resultsManagerSearch.success();
                fillResultsList(results);
                fitToViewport(results);
            }

            if (event.data.errors) {
                errorHintSearch.setMessage('There was an error returned by the service.');
            }
        }

        function handleResultSelection(event) {
            if (isFuzzySearchResult(event)) {
                // Display selected result on the map
                var result = event.data.result;
                resultsManagerSearch.success();
                searchMarkersManager.draw([result]);
                fillResultsList([result]);
                searchMarkersManager.openPopup(result.id);
                fitToViewport(result);
                state.callbackId = null;
                infoHintSearch.hide();
            } else if (stateChangedSinceLastCall(event)) {
                var currentCallbackId = Math.random().toString(36).substring(2, 9);
                state.callbackId = currentCallbackId;
                // Make fuzzySearch call with selected autocomplete result as filter
                handleFuzzyCallForSegment(event, currentCallbackId);
            }
        }

        function isFuzzySearchResult(event) {
            return !('matches' in event.data.result);
        }

        function stateChangedSinceLastCall(event) {
            return Object.keys(searchMarkersManager.getMarkers()).length === 0 || !(
                state.previousOptions.query === event.data.result.value &&
                state.previousOptions.center.toString() === map.getCenter().toString());
        }

        function getBounds(data) {
            var southWest;
            var northEast;
            if (data.viewport) {
                southWest = [data.viewport.topLeftPoint.lng, data.viewport.btmRightPoint.lat];
                northEast = [data.viewport.btmRightPoint.lng, data.viewport.topLeftPoint.lat];
            }
            return [southWest, northEast];
        }

        function fitToViewport(markerData) {
            if (!markerData || markerData instanceof Array && !markerData.length) {
                return;
            }
            var bounds = new tt.LngLatBounds();
            if (markerData instanceof Array) {
                markerData.forEach(function(marker) {
                    bounds.extend(getBounds(marker));
                });
            } else {
                bounds.extend(getBounds(markerData));
            }
            map.fitBounds(bounds, { padding: 100, linear: true });
        }

        function handleFuzzyCallForSegment(event, currentCallbackId) {
            var query = ttSearchBox.getValue();
            var segmentType = event.data.result.type;

            var commonOptions = Object.assign({}, searchOptions, {
                query: query,
                limit: 15,
                center: map.getCenter(),
                typeahead: true,
                language: 'en-GB'
            });

            var filter;
            if (segmentType === 'category') {
                filter = { categorySet: event.data.result.id };
            }
            if (segmentType === 'brand') {
                filter = { brandSet: event.data.result.value };
            }
            var options = Object.assign({}, commonOptions, filter);

            infoHintSearch.setMessage('Loading results...');
            errorHintSearch.hide();
            resultsManagerSearch.loading();
            tt.services.fuzzySearch(options)
                .then(function(response) {
                    if (state.callbackId !== currentCallbackId) {
                        return;
                    }
                    if (response.results.length === 0) {
                        handleNoResults();
                        return;
                    }
                    resultsManagerSearch.success();
                    searchMarkersManager.draw(response.results);
                    fillResultsList(response.results);
                    map.once('moveend', function() {
                        state.previousOptions = {
                            query: query,
                            center: map.getCenter()
                        };
                    });
                    fitToViewport(response.results);
                })
                .catch(function(error) {
                    if (error.data && error.data.errorText) {
                        errorHintSearch.setMessage(error.data.errorText);
                    }
                    resultsManagerSearch.resultsNotFound();
                })
                .finally(function() {
                    infoHintSearch.hide();
                });
        }

        function handleNoResults() {
            resultsManagerSearch.clear();
            resultsManagerSearch.resultsNotFound();
            searchMarkersManager.clear();
            infoHintSearch.setMessage(
                'No results for "' +
                ttSearchBox.getValue() +
                '" found nearby. Try changing the viewport.'
            );
        }

        function fillResultsList(results) {
            resultsManagerSearch.clear();
            var resultList = DomHelpers.createResultList();
            results.forEach(function(result) {
                var distance = state.userLocation ? SearchResultsParser.getResultDistance(result) : undefined;
                var addressLines = SearchResultsParser.getAddressLines(result);
                var searchResult = this.DomHelpers.createSearchResult(
                    addressLines[0],
                    addressLines[1],
                    distance ? Formatters.formatAsMetricDistance(distance) : ''
                );
                var resultItem = DomHelpers.createResultItem();
                resultItem.appendChild(searchResult);
                resultItem.setAttribute('data-id', result.id);
                resultItem.onclick = function(event) {
                    var id = event.currentTarget.getAttribute('data-id');
                    searchMarkersManager.openPopup(id);
                    searchMarkersManager.jumpToMarker(id);
                };
                resultList.appendChild(resultItem);
            });
            resultsManagerSearch.append(resultList);
        }
        </script>
    </body>
</html>
